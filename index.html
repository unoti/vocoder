<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Improved Vocoder</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin-top: 50px;
    }
    button {
      font-size: 18px;
      padding: 10px 20px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>Improved Vocoder Demo</h1>
  <button id="start-vocoder">Start Vocoder</button>

  <script>
    async function initVocoder() {
      const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const analyser = audioCtx.createAnalyser();
      
      // Set FFT size
      analyser.fftSize = 1024; // must be a power of 2
      const bufferLength = analyser.frequencyBinCount;
      const dataArray = new Float32Array(bufferLength);

      // Create a GainNode to control the output volume
      const gainNode = audioCtx.createGain();
      gainNode.gain.value = 0.5;  // Set this to control overall volume

      // Request access to the microphone
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      const source = audioCtx.createMediaStreamSource(stream);

      // Connect microphone input to the analyser
      source.connect(analyser);
      analyser.connect(gainNode);  // Connect the analyser to the gain node
      gainNode.connect(audioCtx.destination);  // Connect the gain node to the output

      // Create a fixed set of oscillators for each frequency bin
      const oscillators = [];
      const gainNodes = [];

      for (let i = 0; i < bufferLength; i++) {
        const frequency = (i * audioCtx.sampleRate) / analyser.fftSize;  // Get frequency for this band

        const osc = audioCtx.createOscillator();
        osc.frequency.setValueAtTime(frequency, audioCtx.currentTime);
        osc.type = 'sine';  // You can experiment with 'sawtooth' or 'square' for different effects

        // Create a gain node for each oscillator to control amplitude
        const oscGain = audioCtx.createGain();
        oscGain.gain.value = 0;  // Start with zero gain

        osc.connect(oscGain);
        oscGain.connect(audioCtx.destination);

        // Start the oscillator
        osc.start();

        // Keep track of the oscillator and gain node
        oscillators.push(osc);
        gainNodes.push(oscGain);
      }

      // Function to update oscillator amplitudes based on the FFT data
      function processAudio() {
        analyser.getFloatFrequencyData(dataArray);  // Get frequency data (in dB)

        // Adjust the gain of each oscillator based on the frequency data
        for (let i = 0; i < bufferLength; i++) {
          const amplitude = Math.max(dataArray[i], -100);  // Clamp amplitude values
          gainNodes[i].gain.setValueAtTime((amplitude + 100) / 1000, audioCtx.currentTime);  // Normalize amplitude
        }

        // Continue processing audio
        requestAnimationFrame(processAudio);
      }

      processAudio();  // Start processing the audio
    }

    // Initialize the vocoder when the button is clicked
    document.querySelector('#start-vocoder').addEventListener('click', () => {
      initVocoder();
    });
  </script>
</body>
</html>
